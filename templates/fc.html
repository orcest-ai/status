<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ view_data.title }}</title>
  <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.6.0/dist/panzoom.min.js"></script>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true, theme: 'dark', securityLevel: 'loose' });
  </script>
  <style>
    :root { --bg:#0a0a0f; --panel:#111827; --line:#1f2937; --txt:#e2e8f0; --muted:#94a3b8; --link:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    body { margin: 0; background: var(--bg); color: var(--txt); font-family: Inter, system-ui, sans-serif; }
    .wrap { max-width: 1280px; margin: 0 auto; padding: 24px; }
    .toolbar, .views { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    .toolbar button, .toolbar a, .views a {
      border: 1px solid #334155; background: var(--panel); color: var(--txt);
      border-radius: 8px; padding: 8px 12px; text-decoration: none; cursor: pointer;
    }
    .toolbar button:hover, .toolbar a:hover, .views a:hover { border-color: var(--link); color: var(--link); }
    .views a.active { border-color: var(--link); color: var(--link); }
    .card { background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 12px; }
    #diagramHost { min-height: 460px; border: 1px dashed #334155; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    #diagramHost svg { touch-action: none; cursor: grab; width: 100%; height: auto; }
    .mermaid { display: none; }
    .grid { margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .panel { background: #0f172a; border: 1px solid #1e293b; border-radius: 10px; padding: 12px; }
    pre { margin: 0; white-space: pre-wrap; word-break: break-word; color: #cbd5e1; font-size: 12px; }
    .hint { margin-top: 10px; color: var(--muted); font-size: 13px; }
    .legend { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; color: var(--muted); font-size: 12px; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
    .ok { background: var(--ok); } .warn { background: var(--warn); } .bad { background: var(--bad); }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>{{ view_data.title }}</h1>
    <p style="color:#94a3b8;">{{ view_data.subtitle }}</p>
    {% if error_message %}
    <p style="color:#f59e0b;">{{ error_message }}</p>
    {% endif %}

    <div class="views">
      {% for view in views %}
      <a href="/fc/{{ view.key }}" class="{% if view.key == current_view %}active{% endif %}">{{ view.title }}</a>
      {% endfor %}
    </div>

    <div class="toolbar">
      <a href="/">Dashboard</a>
      <a href="/api/status?force=true" target="_blank">Open Status JSON</a>
      <a href="/api/topology/{{ current_view }}" target="_blank">Open View API</a>
      <button id="zoomInBtn" type="button">Zoom In</button>
      <button id="zoomOutBtn" type="button">Zoom Out</button>
      <button id="resetBtn" type="button">Reset</button>
      <button id="exportSvgBtn" type="button">Export SVG</button>
      <button id="exportPngBtn" type="button">Export PNG</button>
    </div>

    <div class="card">
      <div id="diagramHost"></div>
      <pre class="mermaid">{{ view_data.mermaid }}</pre>
      <div class="hint">Tip: click a linked node to drill down into that component topology.</div>
      <div class="legend">
        <span><span class="dot ok"></span>Operational</span>
        <span><span class="dot warn"></span>Degraded</span>
        <span><span class="dot bad"></span>Down/Timeout</span>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <strong>Realtime Snapshot</strong>
        <pre id="snapshot">Loading...</pre>
      </div>
      <div class="panel">
        <strong>Linked Nodes in This View</strong>
        <pre id="nodeLinksPanel">Loading...</pre>
      </div>
    </div>
  </div>

  <script>
    const topology = {{ view_data | tojson }};
    const currentView = {{ current_view | tojson }};

    function normalizeLabel(v) {
      return String(v || '').replace(/\s+/g, ' ').trim();
    }

    function downloadFile(filename, content, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function setupPanZoomAndExports(svg) {
      const host = document.getElementById('diagramHost');
      if (!svg || !host || !window.Panzoom) return null;
      host.innerHTML = '';
      host.appendChild(svg);
      const panzoom = window.Panzoom(svg, { maxScale: 3.5, minScale: 0.4, step: 0.2 });
      host.addEventListener('wheel', panzoom.zoomWithWheel, { passive: false });

      document.getElementById('zoomInBtn').addEventListener('click', () => panzoom.zoomIn());
      document.getElementById('zoomOutBtn').addEventListener('click', () => panzoom.zoomOut());
      document.getElementById('resetBtn').addEventListener('click', () => panzoom.reset());

      document.getElementById('exportSvgBtn').addEventListener('click', () => {
        const svgRaw = new XMLSerializer().serializeToString(svg);
        downloadFile(`status-topology-${currentView}.svg`, svgRaw, 'image/svg+xml;charset=utf-8');
      });

      document.getElementById('exportPngBtn').addEventListener('click', () => {
        const svgRaw = new XMLSerializer().serializeToString(svg);
        const image64 = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgRaw)));
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width || 1600;
          canvas.height = img.height || 900;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#0a0a0f';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
          const a = document.createElement('a');
          a.href = canvas.toDataURL('image/png');
          a.download = `status-topology-${currentView}.png`;
          a.click();
        };
        img.src = image64;
      });
      return panzoom;
    }

    function findNodeShape(nodeGroup) {
      return nodeGroup.querySelector('rect, polygon, path, ellipse');
    }

    function nodeLabel(nodeGroup) {
      return normalizeLabel(nodeGroup.textContent);
    }

    function applyNodeLinks(svg) {
      const links = topology.node_links || {};
      document.getElementById('nodeLinksPanel').textContent = JSON.stringify(links, null, 2);
      const linkEntries = Object.entries(links).map(([k, v]) => [normalizeLabel(k), v]);
      svg.querySelectorAll('g.node').forEach((node) => {
        const label = nodeLabel(node);
        const matched = linkEntries.find(([k]) => label.includes(k));
        if (!matched) return;
        const target = matched[1];
        node.style.cursor = 'pointer';
        node.addEventListener('click', () => {
          if (target.startsWith('/')) window.location.href = target;
          else window.open(target, '_blank', 'noopener');
        });
      });
    }

    function colorForStatus(status) {
      if (status === 'operational') return { fill: '#0b3a21', stroke: '#22c55e' };
      if (status === 'degraded') return { fill: '#3a2a08', stroke: '#f59e0b' };
      if (status === 'down' || status === 'timeout' || status === 'partial_outage') return { fill: '#3f1212', stroke: '#ef4444' };
      return { fill: '#1f2937', stroke: '#334155' };
    }

    function applyRealtimeNodeStatus(svg, statusData) {
      const serviceMap = topology.service_map || {};
      const byName = {};
      (statusData.services || []).forEach((s) => { byName[s.name] = s.status; });

      svg.querySelectorAll('g.node').forEach((node) => {
        const label = nodeLabel(node);
        const mapped = Object.entries(serviceMap).find(([k]) => label.includes(normalizeLabel(k)));
        if (!mapped) return;
        const svcName = mapped[1];
        const svcStatus = byName[svcName];
        if (!svcStatus) return;
        const shape = findNodeShape(node);
        if (!shape) return;
        const color = colorForStatus(svcStatus);
        shape.style.fill = color.fill;
        shape.style.stroke = color.stroke;
        shape.style.strokeWidth = '2px';
      });
    }

    async function refreshSnapshotAndStatus(svg) {
      try {
        const r = await fetch('/api/status?force=true');
        const d = await r.json();
        document.getElementById('snapshot').textContent = JSON.stringify({
          overall: d.overall,
          summary: d.summary,
          checked_at: d.checked_at
        }, null, 2);
        if (svg) applyRealtimeNodeStatus(svg, d);
      } catch (e) {
        document.getElementById('snapshot').textContent = 'Failed: ' + e.message;
      }
    }

    window.addEventListener('load', () => {
      setTimeout(() => {
        const svg = document.querySelector('.mermaid svg');
        setupPanZoomAndExports(svg);
        if (svg) applyNodeLinks(svg);
        refreshSnapshotAndStatus(svg);
        setInterval(() => refreshSnapshotAndStatus(svg), 10000);
      }, 350);
    });
  </script>
</body>
</html>

